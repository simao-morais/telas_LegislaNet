<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Pauta - Legisla Net</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèõÔ∏è</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/forms.css">
    <link rel="stylesheet" href="../css/toast.css">
    <style>
        .file-input-help {
            display: block;
            color: var(--secondary-text);
            font-size: 0.8rem;
            margin-top: 4px;
            font-style: italic;
        }
    </style>

</head>
<body>
    <div class="app-layout">
        <div id="sidebar-placeholder"></div>
        <main class="main-content" id="mainContent">
            <div id="header-placeholder"></div>
            <section class="form-section fade-in">
                <h2>Nova Pauta</h2
                    >
                <div class="form-group" style="margin-top: 24px;">
                    <label for="sessao" data-required="true">Sess√£o</label>
                    <select id="sessao" class="form-select" required>
                        <option value="">Carregando sess√µes...</option>
                    </select>
                    <div id="sessao-error" class="form-field-error" style="display: none;"></div>
                </div>
                <div class="form-group" style="margin-top: 24px;">
                    <label for="autor">Autor da pauta</label>
                    <input type="text" id="autor" class="form-input" maxlength="100" placeholder="Ex: Ver. Jo√£o Silva">
                    <div id="autor-error" class="form-field-error" style="display: none;"></div>
                    <small style="color: var(--secondary-text); font-size: 0.75rem; margin-top: 2px; display: block;">
                        <span id="autor-count">0</span>/100 caracteres
                    </small>
                </div>
                <div class="form-group">
                    <label for="nome" data-required="true">Nome</label>
                    <input type="text" id="nome" class="form-input" required maxlength="150" placeholder="Ex: Projeto de Lei 001/2025">
                    <div id="nome-error" class="form-field-error" style="display: none;"></div>
                    <small style="color: var(--secondary-text); font-size: 0.75rem; margin-top: 2px; display: block;">
                        <span id="nome-count">0</span>/150 caracteres
                    </small>
                </div>
                <div class="form-group">
                    <label for="status">Status da Pauta</label>
                    <select id="status" class="form-select">
                        <option value="Pendente">Pendente</option>
                        <option value="Em vota√ß√£o">Em vota√ß√£o</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="descricao">Descri√ß√£o</label>
                    <textarea id="descricao" class="form-textarea" maxlength="500" placeholder="Descreva brevemente o conte√∫do da pauta..."></textarea>
                    <div id="descricao-error" class="form-field-error" style="display: none;"></div>
                    <small style="color: var(--secondary-text); font-size: 0.75rem; margin-top: 2px; display: block;">
                        <span id="descricao-count">0</span>/500 caracteres
                    </small>
                </div>
                <div class="form-group">
                    <label for="file-input">Arquivo PDF</label>
                    <div class="file-input-wrapper">
                        <label for="file-input" class="file-input-button">Procurar PDF...</label>
                        <span id="file-name" class="file-input-text">Nenhum arquivo selecionado.</span>
                        <input type="file" id="file-input" accept=".pdf" multiple="false">
                    </div>
                    <small class="file-input-help">Apenas arquivos PDF s√£o aceitos. Tamanho m√°ximo: 10MB</small>
                </div>
                <div class="form-actions">
                    <button type="submit" id="btnCadastrar" class="btn btn-primary">Cadastrar Pauta</button>
                    <div class="checkbox-group">
                        <input type="checkbox" id="simbolica">
                        <label for="simbolica">Deseja cadastrar vota√ß√£o simb√≥lica?</label>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="../js/global.js"></script>
    <script src="../js/forms.js"></script>
    <script src="../js/toast.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                protectPage();
                initLayout({
                    title: 'Nova Pauta',
                    icon: 'fa-file-pen',
                    navActive: 'nav-cadastro'
                });

                // Carregar sess√µes dispon√≠veis
                await carregarSessoes();

                // Configurar evento do formul√°rio
                configurarFormulario();

                // Configurar input de arquivo
                configurarInputArquivo();

                // Configurar valida√ß√µes e contadores
                configurarValidacoes();

            } catch (e) {
                console.error(e.message);
                return;
            }
        });


        // Fun√ß√£o para carregar sess√µes agendadas futuras
        async function carregarSessoes() {
            try {
                console.log('üì° Carregando sess√µes dispon√≠veis...');
                
                const sessaoSelect = document.getElementById('sessao');
                if (!sessaoSelect) {
                    throw new Error('Select de sess√£o n√£o encontrado');
                }
                
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('Token n√£o encontrado');
                }

                const response = await fetch('/api/sessoes/disponiveis', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erro ao carregar sess√µes: ${response.status}`);
                }

                const result = await response.json();
                const sessoes = result.data || [];
                console.log('üìä Sess√µes recebidas:', sessoes.length);

                // Limpar op√ß√µes atuais
                sessaoSelect.innerHTML = '';

                if (sessoes.length === 0) {
                    console.log('‚ö†Ô∏è Nenhuma sess√£o dispon√≠vel');
                    sessaoSelect.innerHTML = '<option value="">Nenhuma sess√£o agendada dispon√≠vel</option>';
                    return;
                }

                // Adicionar op√ß√£o padr√£o
                sessaoSelect.innerHTML = '<option value="">Selecione a sess√£o correspondente</option>';

                // Adicionar sess√µes
                sessoes.forEach(sessao => {
                    const option = document.createElement('option');
                    option.value = sessao.id;
                    
                    const dataFormatada = new Date(sessao.data_sessao).toLocaleString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    option.textContent = `${sessao.nome} - ${dataFormatada}`;
                    sessaoSelect.appendChild(option);
                });
                
                console.log('‚úÖ Sess√µes carregadas com sucesso:', sessoes.length, 'op√ß√µes');

            } catch (error) {
                console.error('‚ùå Erro ao carregar sess√µes:', error);
                const sessaoSelect = document.getElementById('sessao');
                if (sessaoSelect) {
                    sessaoSelect.innerHTML = '<option value="">Erro ao carregar sess√µes</option>';
                }
                showToast('Erro ao carregar sess√µes dispon√≠veis', 'error');
            }
        }

        // Configurar valida√ß√µes e contadores de caracteres
        function configurarValidacoes() {
            // Campos com contadores
            const campos = [
                { id: 'nome', max: 150 },
                { id: 'autor', max: 100 },
                { id: 'descricao', max: 500 }
            ];

            campos.forEach(campo => {
                const input = document.getElementById(campo.id);
                const counter = document.getElementById(`${campo.id}-count`);
                
                if (input && counter) {
                    // Atualizar contador em tempo real
                    input.addEventListener('input', () => {
                        const count = input.value.length;
                        counter.textContent = count;
                        
                        // Mudar cor quando perto do limite
                        if (count > campo.max * 0.9) {
                            counter.style.color = 'var(--accent-orange)';
                        } else if (count >= campo.max) {
                            counter.style.color = 'var(--accent-red)';
                        } else {
                            counter.style.color = 'var(--secondary-text)';
                        }
                    });
                }
            });
        }

        // Fun√ß√£o para mostrar erro de valida√ß√£o
        function mostrarErro(campoId, mensagem) {
            const errorDiv = document.getElementById(`${campoId}-error`);
            const campo = document.getElementById(campoId);
            
            if (campo) {
                campo.classList.add('form-input-error');
                campo.focus();
            }
            
            if (errorDiv) {
                errorDiv.textContent = mensagem;
                errorDiv.style.display = 'flex';
                return true;
            }
            return false;
        }

        // Fun√ß√£o para limpar erro de valida√ß√£o
        function limparErro(campoId) {
            const errorDiv = document.getElementById(`${campoId}-error`);
            const campo = document.getElementById(campoId);
            
            if (campo) {
                campo.classList.remove('form-input-error');
            }
            
            if (errorDiv) {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            }
        }

        // Fun√ß√£o para limpar todos os erros
        function limparTodosErros() {
            ['sessao', 'nome', 'autor', 'descricao'].forEach(limparErro);
        }

        // Fun√ß√£o para verificar duplicidade de pauta
        async function verificarDuplicidade(nome, sessaoId) {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) return false;

                const response = await fetch(`/api/pautas?nome=${encodeURIComponent(nome)}&sessao_id=${sessaoId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    return result.data && result.data.length > 0;
                }
                
                return false;
            } catch (error) {
                console.error('Erro ao verificar duplicidade:', error);
                return false;
            }
        }

        // Configurar input de arquivo
        function configurarInputArquivo() {
            const fileInput = document.getElementById('file-input');
            const fileName = document.getElementById('file-name');
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Verificar se √© PDF
                    if (file.type !== 'application/pdf') {
                        alert('Apenas arquivos PDF s√£o aceitos!');
                        fileInput.value = '';
                        fileName.textContent = 'Nenhum arquivo selecionado.';
                        return;
                    }
                    
                    // Verificar tamanho (10MB = 10 * 1024 * 1024 bytes)
                    if (file.size > 10 * 1024 * 1024) {
                        alert('Arquivo muito grande! Tamanho m√°ximo: 10MB');
                        fileInput.value = '';
                        fileName.textContent = 'Nenhum arquivo selecionado.';
                        return;
                    }
                    
                    fileName.textContent = file.name;
                } else {
                    fileName.textContent = 'Nenhum arquivo selecionado.';
                }
            });
        }

        // Configurar formul√°rio de cadastro
        function configurarFormulario() {
            const btnCadastrar = document.getElementById('btnCadastrar');
            
            btnCadastrar.addEventListener('click', async (e) => {
                e.preventDefault();
                await cadastrarPauta();
            });
        }

        // Fun√ß√£o para cadastrar pauta
        async function cadastrarPauta() {
            try {
                const btnCadastrar = document.getElementById('btnCadastrar');
                const originalText = btnCadastrar.textContent;
                
                // Desabilitar bot√£o e mostrar loading
                btnCadastrar.disabled = true;
                btnCadastrar.textContent = 'Cadastrando...';

                // Coletar dados do formul√°rio
                const formData = new FormData();
                
                const sessao_id = document.getElementById('sessao').value;
                const autor = document.getElementById('autor').value.trim();
                const nome = document.getElementById('nome').value.trim();
                const status = document.getElementById('status').value;
                const descricao = document.getElementById('descricao').value.trim();
                const votacao_simbolica = document.getElementById('simbolica').checked;
                const fileInput = document.getElementById('file-input');
                
                // Limpar erros anteriores
                limparTodosErros();

                let hasErrors = false;

                // Valida√ß√µes com form-field-error
                if (!sessao_id) {
                    mostrarErro('sessao', 'Selecione uma sess√£o');
                    hasErrors = true;
                }

                if (!nome.trim()) {
                    mostrarErro('nome', 'Nome da pauta √© obrigat√≥rio');
                    hasErrors = true;
                } else if (nome.trim().length < 5) {
                    mostrarErro('nome', 'Nome deve ter pelo menos 5 caracteres');
                    hasErrors = true;
                } else if (nome.trim().length > 150) {
                    mostrarErro('nome', 'Nome n√£o pode exceder 150 caracteres');
                    hasErrors = true;
                }

                if (autor.trim().length > 100) {
                    mostrarErro('autor', 'Autor n√£o pode exceder 100 caracteres');
                    hasErrors = true;
                }

                if (descricao.trim().length > 500) {
                    mostrarErro('descricao', 'Descri√ß√£o n√£o pode exceder 500 caracteres');
                    hasErrors = true;
                }

                if (hasErrors) {
                    return;
                }

                // Verificar duplicidade de pauta na sess√£o
                if (await verificarDuplicidade(nome.trim(), sessao_id)) {
                    mostrarErro('nome', 'J√° existe uma pauta com este nome nesta sess√£o');
                    return;
                }

                // Adicionar dados ao FormData
                formData.append('sessao_id', sessao_id);
                formData.append('nome', nome);
                formData.append('status', status);
                formData.append('votacao_simbolica', votacao_simbolica);
                
                if (autor) formData.append('autor', autor);
                if (descricao) formData.append('descricao', descricao);
                
                // Adicionar arquivo se selecionado
                if (fileInput.files[0]) {
                    formData.append('arquivo', fileInput.files[0]);
                }

                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('Token n√£o encontrado');
                }

                const response = await fetch('/api/pautas', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                        // N√£o definir Content-Type para FormData - o browser faz isso automaticamente
                    },
                    body: formData
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || `Erro ${response.status}`);
                }

                showToast('Pauta(s) cadastrada(s) com sucesso!', 'success');
                
                // Limpar formul√°rio
                document.getElementById('sessao').value = '';
                document.getElementById('status').value = 'Pendente';
                document.getElementById('autor').value = '';
                document.getElementById('nome').value = '';
                document.getElementById('descricao').value = '';
                document.getElementById('file-input').value = '';
                document.getElementById('file-name').textContent = 'Nenhum arquivo selecionado.';
                document.getElementById('simbolica').checked = false;
                
                // Resetar contadores
                document.getElementById('autor-count').textContent = '0';
                document.getElementById('nome-count').textContent = '0';
                document.getElementById('descricao-count').textContent = '0';

            } catch (error) {
                console.error('Erro ao cadastrar pauta:', error);
                showToast(error.message, 'error');
            } finally {
                // Reabilitar bot√£o
                const btnCadastrar = document.getElementById('btnCadastrar');
                btnCadastrar.disabled = false;
                btnCadastrar.textContent = 'Cadastrar Pauta';
            }
        }
    </script>
</body>
</html>
