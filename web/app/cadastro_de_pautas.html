<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro de Pautas - Legisla Net</title>

    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèõÔ∏è</text></svg>"
    />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
    />

    <link rel="stylesheet" href="../css/global.css" />
    <link rel="stylesheet" href="../css/modals.css" />
    <link rel="stylesheet" href="../css/pagination.css" />

    <style>
      .pautas-section {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 24px 24px 0 24px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        min-height: 0; /* Permite que o flex funcione corretamente */
      }
      .pautas-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }
      .pautas-header h2 {
        font-size: 1.25rem;
      }
      .pautas-filters {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
      }
      .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--secondary-text);
        font-size: 0.875rem;
      }
      .custom-select {
        background-color: var(--hover-bg);
        border: 1px solid var(--border-color);
        color: var(--primary-text);
        padding: 6px 12px;
        border-radius: 6px;
      }
      .table-container {
        flex-grow: 1;
        overflow-x: auto;
      }
      .pautas-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
      }
      .pautas-table th,
      .pautas-table td {
        padding: 12px 16px;
        text-align: left;
        white-space: nowrap;
        vertical-align: middle;
      }
      .pautas-table tbody tr {
        border-bottom: 1px solid var(--border-color);
        transition: background-color 0.2s;
      }
      .pautas-table tbody tr:hover {
        background-color: var(--hover-bg);
      }
      .pautas-table th {
        color: var(--secondary-text);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
      }
      .pautas-table td .description {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 250px;
        display: block;
      }
      .pautas-table .link {
        color: var(--accent-blue);
        text-decoration: none;
        font-weight: 500;
      }

      .status-cell {
        position: relative;
      }
      .status-dropdown {
        display: flex;
        flex-direction: column;
        gap: 4px;
        cursor: pointer;
      }
      .status-badge-wrapper {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 4px;
        border-radius: 99px;
        transition: background-color 0.2s;
        border: 1px solid transparent;
      }
      .status-dropdown:hover .status-badge-wrapper {
        background-color: var(--hover-bg);
        border-color: var(--border-color);
      }
      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 99px;
        font-weight: 500;
        font-size: 0.8rem;
        text-align: center;
        white-space: nowrap;
      }
      /* Cores originais das tags com bordas espec√≠ficas */
      .status-badge.pendente {
        background-color: rgba(240, 227, 51, 0.2);
        color: rgb(233, 241, 110);
        border: 1px solid rgba(240, 227, 51, 0.4);
      }
      .status-badge.em-votacao {
        background-color: rgba(88, 166, 255, 0.2);
        color: aqua;
        border: 1px solid rgba(88, 166, 255, 0.4);
      }
      .status-badge.finalizada {
        background-color: rgba(46, 160, 67, 0.2);
        color: #71e67f;
        border: 1px solid rgba(46, 160, 67, 0.4);
      }
      .status-badge.simbolica {
        background-color: rgba(218, 54, 51, 0.2);
        color: #f85149;
        border: 1px solid rgba(218, 54, 51, 0.4);
        margin-top: 4px;
      }

      .status-dropdown .fa-chevron-down {
        color: var(--secondary-text);
        font-size: 0.7rem;
        margin-right: 8px;
        transition: transform 0.2s;
      }
      .status-dropdown.open .fa-chevron-down {
        transform: rotate(180deg);
      }
      .dropdown-menu {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 4px;
        z-index: 1000;
        min-width: 100%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        max-height: 200px;
        overflow-y: auto;
      }
      .status-dropdown.open .dropdown-menu {
        display: block;
      }
      /* Dropdown que abre para cima quando necess√°rio */
      .status-dropdown.dropdown-up .dropdown-menu {
        top: auto;
        bottom: 100%;
        margin-bottom: 2px;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
      }
      /* Garantir que o container da tabela permite overflow para dropdowns */
      .table-container {
        flex-grow: 1;
        overflow-x: auto;
        overflow-y: visible;
        position: relative;
      }
      .dropdown-item {
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        color: var(--primary-text);
      }
      .dropdown-item:hover {
        background-color: var(--accent-blue);
        color: white;
      }
      .modal-body.confirm-text p {
        line-height: 1.5;
        color: var(--secondary-text);
      }
    </style>
  </head>
  <body>
    <div class="app-layout">
      <div id="sidebar-placeholder"></div>

      <main class="main-content" id="mainContent">
        <div id="header-placeholder"></div>

        <section class="pautas-section fade-in">
          <div class="pautas-header">
            <h2>Pautas</h2>
            <!-- Adicionado data-action para o listener delegado -->
            <button class="btn btn-primary" data-action="nova-pauta">
              Nova Pauta
            </button>
          </div>

          <div class="pautas-filters">
            <div class="filter-group">
              <label for="status-filter">Filtrar por status:</label>
              <select id="status-filter" class="custom-select">
                <option>Todos os status</option>
                <option>Em vota√ß√£o</option>
                <option>Finalizada</option>
                <option>Pendente</option>
              </select>
            </div>
            <span>5 de 90 pautas</span>
          </div>

          <div class="table-container">
            <table class="pautas-table">
              <thead>
                <tr>
                  <th>Nome da Pauta</th>
                  <th>Descri√ß√£o</th>
                  <th>Link</th>
                  <th>Status</th>
                  <th>Autor</th>
                  <th>Sess√£o</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                <!-- Dados carregados dinamicamente via JavaScript -->
              </tbody>
            </table>
          </div>

          <div class="pagination-container" id="pagination-container">
            <div class="pagination-controls" id="pagination-controls"></div>
          </div>
        </section>
      </main>
    </div>

    <div class="modal-overlay" id="removerPautaModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Confirmar Exclus√£o</h3>
          <button class="modal-close" onclick="closeModal('removerPautaModal')">
            <i class="fa-solid fa-times"></i>
          </button>
        </div>
        <div class="modal-body confirm-text">
          <p>Voc√™ tem certeza que deseja remover esta pauta?</p>
          <p>Esta a√ß√£o n√£o poder√° ser desfeita.</p>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            onclick="closeModal('removerPautaModal')"
          >
            Cancelar
          </button>
          <button
            type="button"
            class="btn"
            style="background-color: var(--accent-red); color: white"
          >
            Excluir
          </button>
        </div>
      </div>
    </div>

    <script src="../js/global.js"></script>
    <script src="../js/modals.js"></script>
    <script src="../js/pagination.js"></script>

    <script>
      let pautas = [];
      let pautasFiltradas = [];
      let currentPage = 1;
      const PAUTAS_PER_PAGE = 8;

      document.addEventListener("DOMContentLoaded", async () => {
        // Script para Dropdown de Status

        try {
          protectPage();
          initLayout({
            title: "Cadastro de Pautas",
            icon: "fa-file-lines",
            navActive: "nav-cadastro",
          });

          {
            autoFixFormSectionLayout();
          }

          // Carregar pautas do banco
          await carregarPautas();
          
          // Verifica√ß√£o adicional de seguran√ßa para dropdowns ap√≥s carregamento inicial
          setTimeout(() => {
            console.log('üîç SAFETY CHECK: Verificando se todos os dropdowns foram configurados...');
            const allDropdowns = document.querySelectorAll('.status-dropdown');
            const unconfiguredDropdowns = document.querySelectorAll('.status-dropdown .status-badge-wrapper:not([data-configured="true"])');
            
            console.log(`üìä SAFETY CHECK: Total dropdowns: ${allDropdowns.length}, N√£o configurados: ${unconfiguredDropdowns.length}`);
            
            if (unconfiguredDropdowns.length > 0) {
              console.warn('‚ö†Ô∏è SAFETY CHECK: Alguns dropdowns n√£o foram configurados, tentando novamente...');
              configurarDropdowns();
            } else {
              console.log('‚úÖ SAFETY CHECK: Todos os dropdowns est√£o configurados corretamente');
            }
          }, 500);
        } catch (e) {
          console.error(e.message);
          return; // Interrompe a execu√ß√£o se n√£o estiver autenticado.
        }

        // Delega√ß√£o de evento robusta: busca o elemento mais pr√≥ximo com data-action
        document.addEventListener("click", (e) => {
          const el = e.target.closest("[data-action]");
          if (!el) return;
          const action = el.dataset.action;

          if (action === "nova-pauta") {
            console.log(
              "A√ß√£o nova-pauta detectada ‚Üí navigateToPage('nova_pauta')"
            );
            navigateToPage("nova_pauta");
          } else if (action === "editar-pauta") {
            console.log(
              "A√ß√£o editar-pauta detectada ‚Üí navigateToPage('editar_pauta')"
            );
            navigateToPage("editar_pauta");
          } else if (action === "remover-pauta") {
            console.log(
              "A√ß√£o remover-pauta detectada ‚Üí openModal('removerPautaModal')"
            );
            openModal("removerPautaModal");
          }
        });

        const statusDropdowns = document.querySelectorAll(".status-dropdown");
        statusDropdowns.forEach((dropdown) => {
          const badgeWrapper = dropdown.querySelector(".status-badge-wrapper");
          const dropdownMenu = dropdown.querySelector(".dropdown-menu");

          badgeWrapper.addEventListener("click", (event) => {
            event.stopPropagation();
            closeAllDropdowns(dropdown);
            dropdown.classList.toggle("open");
          });

          dropdownMenu.querySelectorAll(".dropdown-item").forEach((item) => {
            item.addEventListener("click", () => {
              const newValue = item.getAttribute("data-value");
              const newText = item.textContent;
              const mainBadge = dropdown.querySelector(
                ".status-badge-wrapper .status-badge"
              );
              if (mainBadge) {
                mainBadge.classList.remove(
                  "pendente",
                  "em-votacao",
                  "finalizada"
                );
                mainBadge.classList.add(newValue);
                mainBadge.textContent = newText.toUpperCase();
              }
              dropdown.classList.remove("open");
              console.log(`Status alterado para: ${newValue}`);
            });
          });
        });

        function closeAllDropdowns(exceptThisOne = null) {
          // Buscar apenas dropdowns que realmente existem no DOM atual
          const allDropdowns = document.querySelectorAll('.status-dropdown');
          const openDropdowns = Array.from(allDropdowns).filter(dropdown => dropdown.classList.contains('open'));
          
          console.log(`üîí CLOSE ALL: Dropdowns no DOM: ${allDropdowns.length}, Realmente abertos: ${openDropdowns.length}${exceptThisOne ? ' (exceto um)' : ''}`);
          
          let closedCount = 0;
          allDropdowns.forEach((dropdown) => {
            if (dropdown !== exceptThisOne) {
              const wasOpen = dropdown.classList.contains("open");
              
              if (wasOpen) {
                dropdown.classList.remove("open");
                dropdown.classList.remove("dropdown-up");
                const pautaId = dropdown.dataset.pautaId || 'desconhecida';
                console.log(`üîí CLOSE ALL: Fechado dropdown da pauta ${pautaId}`);
                closedCount++;
              }
            }
          });
          
          console.log(`üîí CLOSE ALL: ${closedCount} dropdowns realmente fechados`);
        }

        // Fechar dropdowns ao clicar fora
        window.addEventListener("click", (event) => {
          // Verificar se o clique foi dentro de algum dropdown
          const clickedDropdown = event.target.closest('.status-dropdown');
          
          if (!clickedDropdown) {
            console.log('üîí CLICK OUTSIDE: Fechando todos os dropdowns (clique fora)');
            const openDropdowns = document.querySelectorAll('.status-dropdown.open');
            console.log(`üîí CLICK OUTSIDE: Encontrados ${openDropdowns.length} dropdowns abertos para fechar`);
            
            // Resetar tracking manual al√©m de fechar visualmente
            const allDropdowns = document.querySelectorAll('.status-dropdown');
            allDropdowns.forEach(dropdown => {
              dropdown.classList.remove('open', 'dropdown-up');
              const badge = dropdown.querySelector('.status-badge-wrapper');
              if (badge) {
                badge._dropdownState = 'closed';
              }
            });
            
            console.log(`üîí CLICK OUTSIDE: Tracking manual resetado para todos os dropdowns`);
          }
        });

        // Fun√ß√£o para carregar pautas do banco
        async function carregarPautas(page = 1, filtros = {}) {
          try {
            console.log(`üì° Carregando pautas - P√°gina ${page}...`);

            const token = localStorage.getItem("authToken");
            if (!token) {
              throw new Error("Token n√£o encontrado");
            }

            // Construir URL com par√¢metros de pagina√ß√£o e filtros
            const params = new URLSearchParams({
              page: page,
              limit: PAUTAS_PER_PAGE,
              ...filtros,
            });

            const response = await fetch(`/api/pautas?${params}`, {
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            });

            if (!response.ok) {
              throw new Error(`Erro ao carregar pautas: ${response.status}`);
            }

            const result = await response.json();
            pautas = result.data || [];

            console.log(
              `‚úÖ ${pautas.length} pautas carregadas (P√°gina ${page})`
            );

            // Renderizar tabela com os dados
            renderizarTabela();
            atualizarContador(result.pagination);

            // Configurar pagina√ß√£o
            configurarPaginacao(result.pagination);
          } catch (error) {
            console.error("‚ùå Erro ao carregar pautas:", error);
            mostrarMensagemErro("Erro ao carregar pautas do banco de dados");
          }
        }

        // Fun√ß√£o para renderizar a tabela
        function renderizarTabela() {
          console.log('üé® RENDER: Iniciando renderiza√ß√£o da tabela...');
          
          // LIMPEZA CR√çTICA: Garantir que todos os dropdowns s√£o fechados antes de renderizar nova p√°gina
          const existingDropdowns = document.querySelectorAll('.status-dropdown');
          console.log(`üßπ RENDER: Limpando ${existingDropdowns.length} dropdowns existentes antes da renderiza√ß√£o...`);
          
          existingDropdowns.forEach((dropdown, index) => {
            const wasOpen = dropdown.classList.contains('open');
            dropdown.classList.remove('open', 'dropdown-up');
            
            // Resetar tracking manual tamb√©m
            const badge = dropdown.querySelector('.status-badge-wrapper');
            if (badge) {
              badge._dropdownState = 'closed';
            }
            
            if (wasOpen) {
              const pautaId = dropdown.dataset.pautaId || `dropdown-${index}`;
              console.log(`üßπ RENDER: Dropdown da pauta ${pautaId} foi limpo (estava aberto, tracking resetado)`);
            }
          });
          
          const tbody = document.querySelector(".pautas-table tbody");

          if (pautas.length === 0) {
            console.log('üìã RENDER: Nenhuma pauta para exibir');
            tbody.innerHTML = `
              <tr>
                <td colspan="7" style="text-align: center; padding: 2rem; color: var(--secondary-text);">
                  <i class="fa-regular fa-file-lines" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                  Nenhuma pauta encontrada
                </td>
              </tr>
            `;
            return;
          }

          console.log(`üìã RENDER: Renderizando ${pautas.length} pautas...`);

          tbody.innerHTML = pautas
            .map((pauta, index) => {
              // Mapeamento correto de status para classes CSS
              const getStatusClass = (status) => {
                if (!status) return "pendente";
                
                const statusMap = {
                  "pendente": "pendente",
                  "em vota√ß√£o": "em-votacao",
                  "finalizada": "finalizada"
                };
                
                const normalized = status.toLowerCase().trim();
                const cssClass = statusMap[normalized] || "pendente";
                
                console.log(`üé® STATUS CLASS: "${status}" ‚Üí "${normalized}" ‚Üí "${cssClass}"`);
                return cssClass;
              };
              
              const statusClass = getStatusClass(pauta.status);
              const statusText = pauta.status || "Pendente";

              // Fun√ß√£o para truncar texto com limite
              const truncateText = (text, maxLength, fallback = "N/A") => {
                if (!text) return fallback;
                return text.length > maxLength
                  ? text.substring(0, maxLength) + "..."
                  : text;
              };

              // Processar campos com limites
              const nome = truncateText(pauta.nome, 35, "Sem nome");
              const nomeFull = pauta.nome || "Sem nome";
              const descricao = truncateText(
                pauta.descricao,
                40,
                "Sem descri√ß√£o"
              );
              const descricaoFull = pauta.descricao || "Sem descri√ß√£o";
              const autor = truncateText(pauta.autor, 25, "N√£o informado");
              const autorFull = pauta.autor || "N√£o informado";
              const sessaoNome = truncateText(pauta.sessoes?.nome, 30, "N/A");
              const sessaoFull = pauta.sessoes?.nome || "N/A";

              // Verificar se tem arquivo anexo
              const linkArquivo = pauta.anexo_url
                ? `<a href="${pauta.anexo_url}" target="_blank" class="link">Acessar PDF</a>`
                : '<span style="color: var(--secondary-text);">Sem arquivo</span>';

              // Badge para vota√ß√£o simb√≥lica
              const badgeSimbolica = pauta.votacao_simbolica
                ? '<span class="status-badge simbolica">Vota√ß√£o simb√≥lica</span>'
                : "";

              console.log(`üìÑ RENDER: Pauta ${index + 1}/${pautas.length} - ID: ${pauta.id}, Status: ${statusText}`);

              return `
              <tr data-pauta-id="${pauta.id}">
                <td title="${nomeFull}">${nome}</td>
                <td>
                  <span class="description" title="${descricaoFull}">
                    ${descricao}
                  </span>
                </td>
                <td>${linkArquivo}</td>
                <td class="status-cell">
                  <div class="status-dropdown" data-pauta-id="${pauta.id}" data-status="${statusText}">
                    <div class="status-badge-wrapper">
                      <span class="status-badge ${statusClass}">${statusText.toUpperCase()}</span>
                      <i class="fa-solid fa-chevron-down"></i>
                    </div>
                    <div class="dropdown-menu">
                      <div class="dropdown-item" data-value="pendente">Pendente</div>
                      <div class="dropdown-item" data-value="em-votacao">Em Vota√ß√£o</div>
                      <div class="dropdown-item" data-value="finalizada">Finalizada</div>
                    </div>
                  </div>
                  ${badgeSimbolica}
                </td>
                <td title="${autorFull}">${autor}</td>
                <td title="${sessaoFull}">${sessaoNome}</td>
                <td class="actions-cell">
                  <button class="btn btn-action btn-edit" data-action="editar-pauta" data-pauta-id="${
                    pauta.id
                  }">
                    Editar
                  </button>
                  <button class="btn btn-action btn-remove" data-action="remover-pauta" data-pauta-id="${
                    pauta.id
                  }">
                    Remover
                  </button>
                </td>
              </tr>
            `;
            })
            .join("");

          console.log('‚úÖ RENDER: HTML da tabela inserido no DOM');
          
          // Aguardar o DOM atualizar completamente antes de configurar dropdowns
          setTimeout(() => {
            console.log('‚è∞ RENDER: Iniciando configura√ß√£o de dropdowns ap√≥s timeout...');
            configurarDropdowns();
          }, 100);
        }

        // Fun√ß√£o para configurar dropdowns de status
        function configurarDropdowns() {
          console.log('üîß DROPDOWN: Iniciando configura√ß√£o dos dropdowns...');
          
          // DIAGN√ìSTICO INICIAL: Verificar se algum dropdown j√° tem classe open
          const preExistingOpen = document.querySelectorAll('.status-dropdown.open');
          if (preExistingOpen.length > 0) {
            console.warn(`üö® DIAGN√ìSTICO: Encontrados ${preExistingOpen.length} dropdowns com classe 'open' ANTES da configura√ß√£o!`);
            preExistingOpen.forEach((problematic, idx) => {
              const problematicId = problematic.dataset.pautaId || `dropdown-${idx}`;
              console.warn(`üö® DIAGN√ìSTICO: Dropdown problem√°tico: ${problematicId}`);
              console.warn(`üö® DIAGN√ìSTICO: Classes:`, Array.from(problematic.classList));
              
              // Limpar imediatamente
              problematic.classList.remove('open', 'dropdown-up');
              console.warn(`üö® DIAGN√ìSTICO: Limpeza preventiva aplicada para ${problematicId}`);
            });
          }
          
          const statusDropdowns = document.querySelectorAll(".status-dropdown");
          console.log(`üî¢ DROPDOWN: Encontrados ${statusDropdowns.length} dropdowns para configurar`);

          if (statusDropdowns.length === 0) {
            console.warn('‚ö†Ô∏è DROPDOWN: Nenhum dropdown encontrado! Verificando se a tabela foi renderizada...');
            const tbody = document.querySelector(".pautas-table tbody");
            console.log('üìã DROPDOWN: Conte√∫do do tbody:', tbody?.innerHTML?.substring(0, 200) + '...');
            return;
          }

          statusDropdowns.forEach((dropdown, index) => {
            const pautaId = dropdown.dataset.pautaId;
            const currentStatus = dropdown.dataset.status;
            
            console.log(`‚öôÔ∏è DROPDOWN ${index + 1}/${statusDropdowns.length}: Configurando pauta ${pautaId} (Status: ${currentStatus})`);
            
            const badgeWrapper = dropdown.querySelector(".status-badge-wrapper");
            const dropdownMenu = dropdown.querySelector(".dropdown-menu");

            if (!badgeWrapper) {
              console.error(`‚ùå DROPDOWN ${index + 1}: Badge wrapper n√£o encontrado para pauta ${pautaId}`);
              return;
            }

            if (!dropdownMenu) {
              console.error(`‚ùå DROPDOWN ${index + 1}: Menu n√£o encontrado para pauta ${pautaId}`);
              return;
            }

            // Verificar se j√° tem event listeners (indicador de duplica√ß√£o)
            if (badgeWrapper.dataset.configured === 'true') {
              console.warn(`‚ö†Ô∏è DROPDOWN ${index + 1}: Badge wrapper j√° configurado para pauta ${pautaId}, pulando...`);
              return;
            }

            console.log(`üîß DROPDOWN ${index + 1}: Configurando event listeners...`);

            // Marcar como configurado
            badgeWrapper.dataset.configured = 'true';
            dropdownMenu.dataset.configured = 'true';

            // Vari√°vel para tracking manual do estado
            let dropdownState = 'closed';
            
            badgeWrapper.addEventListener("click", (event) => {
              console.log(`üëÜ DROPDOWN CLICK: Pauta ${pautaId} - Badge clicado`);
              event.stopPropagation();
              
              // Verificar estado via classe E via tracking manual
              const classState = dropdown.classList.contains("open");
              console.log(`üîç DROPDOWN STATE: Pauta ${pautaId} - Classe: ${classState ? 'ABERTO' : 'FECHADO'}, Tracking: ${dropdownState}`);
              
              // SEMPRE limpar todos os dropdowns primeiro
              console.log(`üßπ DROPDOWN CLICK: Limpeza TOTAL de todos os dropdowns...`);
              
              const allDropdowns = document.querySelectorAll('.status-dropdown');
              allDropdowns.forEach((anyDropdown, idx) => {
                anyDropdown.classList.remove('open', 'dropdown-up');
                // Resetar tracking de todos os outros dropdowns
                const otherBadge = anyDropdown.querySelector('.status-badge-wrapper');
                if (otherBadge && otherBadge !== badgeWrapper) {
                  otherBadge._dropdownState = 'closed';
                }
              });
              
              console.log(`üßπ LIMPEZA TOTAL: Todos os dropdowns limpos`);
              
              // Decidir a√ß√£o baseada no tracking manual
              if (dropdownState === 'closed') {
                // ABRIR
                dropdown.classList.add("open");
                dropdownState = 'open';
                badgeWrapper._dropdownState = 'open';
                console.log(`üéØ DROPDOWN CLICK: Pauta ${pautaId} - ABRINDO`);
                
                // Calcular posicionamento
                requestAnimationFrame(() => {
                  const rect = dropdown.getBoundingClientRect();
                  const menuRect = dropdownMenu.getBoundingClientRect();
                  const viewportHeight = window.innerHeight;
                  const containerRect = dropdown.closest('.table-container')?.getBoundingClientRect();
                  const containerBottom = containerRect ? containerRect.bottom : viewportHeight;
                  
                  const spaceBelow = Math.min(viewportHeight, containerBottom) - rect.bottom;
                  const spaceAbove = rect.top;
                  
                  console.log(`üìê DROPDOWN POSITION: Pauta ${pautaId}`, {
                    spaceBelow: Math.round(spaceBelow),
                    spaceAbove: Math.round(spaceAbove),
                    menuHeight: Math.round(menuRect.height),
                    viewportHeight,
                    containerBottom: containerRect ? Math.round(containerBottom) : 'N/A'
                  });
                  
                  const safetyMargin = 20;
                  const needsSpaceBelow = menuRect.height + safetyMargin;
                  
                  if (spaceBelow < needsSpaceBelow && spaceAbove > needsSpaceBelow) {
                    dropdown.classList.add("dropdown-up");
                    console.log(`‚¨ÜÔ∏è DROPDOWN POSITION: Pauta ${pautaId} - Abrindo para CIMA`);
                  } else if (spaceBelow < needsSpaceBelow && spaceAbove < needsSpaceBelow) {
                    dropdown.classList.add("dropdown-up");
                    console.log(`‚¨ÜÔ∏è DROPDOWN POSITION: Pauta ${pautaId} - FOR√áANDO para CIMA`);
                  } else {
                    dropdown.classList.remove("dropdown-up");
                    console.log(`‚¨áÔ∏è DROPDOWN POSITION: Pauta ${pautaId} - Abrindo para BAIXO`);
                  }
                });
              } else {
                // FECHAR (j√° foi limpo na limpeza total)
                dropdownState = 'closed';
                badgeWrapper._dropdownState = 'closed';
                console.log(`üéØ DROPDOWN CLICK: Pauta ${pautaId} - FECHANDO`);
              }
            });
            
            // Inicializar tracking
            badgeWrapper._dropdownState = 'closed';

            // Configurar items do dropdown
            const menuItems = dropdownMenu.querySelectorAll(".dropdown-item");
            console.log(`üìã DROPDOWN ${index + 1}: Configurando ${menuItems.length} itens do menu`);

            menuItems.forEach((item, itemIndex) => {
              const itemValue = item.getAttribute("data-value");
              const itemText = item.textContent;
              
              console.log(`üìù DROPDOWN ${index + 1}: Item ${itemIndex + 1} - ${itemValue}: ${itemText}`);
              
              item.addEventListener("click", async (event) => {
                console.log(`üéØ MENU ITEM CLICK: Pauta ${pautaId} - Selecionado: ${itemText} (${itemValue})`);
                event.stopPropagation();
                
                const newValue = itemValue;
                const newText = itemText;
                const mainBadge = dropdown.querySelector(".status-badge-wrapper .status-badge");

                // Fechar dropdown imediatamente
                dropdown.classList.remove("open");
                console.log(`üîí MENU ITEM: Dropdown fechado para pauta ${pautaId}`);

                // Atualizar status no banco de dados
                try {
                  console.log(`üì° API CALL: Atualizando pauta ${pautaId} para status "${newText}"`);
                  await atualizarStatusPauta(pautaId, newText);
                  
                  // Atualizar visualmente apenas se a requisi√ß√£o foi bem-sucedida
                  if (mainBadge) {
                    const oldClasses = Array.from(mainBadge.classList);
                    
                    // Remover todas as classes de status poss√≠veis
                    mainBadge.classList.remove("pendente", "em-votacao", "finalizada");
                    
                    // Aplicar classe correta baseada no newValue (que vem do data-value)
                    mainBadge.classList.add(newValue);
                    mainBadge.textContent = newText.toUpperCase();
                    
                    console.log(`‚úÖ UI UPDATE: Pauta ${pautaId} - Classes: ${oldClasses.join(',')} ‚Üí ${Array.from(mainBadge.classList).join(',')}`);
                    console.log(`‚úÖ UI UPDATE: Pauta ${pautaId} - Texto: "${currentStatus}" ‚Üí "${newText.toUpperCase()}"`);
                    console.log(`‚úÖ UI UPDATE: Pauta ${pautaId} - Classe aplicada: "${newValue}"`);
                  }
                  
                  console.log(`üéâ SUCCESS: Pauta ${pautaId} atualizada com sucesso para ${newValue}`);
                } catch (error) {
                  console.error(`‚ùå ERROR: Falha ao atualizar pauta ${pautaId}:`, error);
                  // N√£o atualizar visualmente se houve erro
                }
              });
            });
            
            console.log(`‚úÖ DROPDOWN ${index + 1}: Configura√ß√£o conclu√≠da para pauta ${pautaId}`);
            
            // VERIFICA√á√ÉO FINAL: Monitorar se a classe open aparece mysteriosamente
            setTimeout(() => {
              if (dropdown.classList.contains('open')) {
                console.error(`üö® MYSTERY BUG: Dropdown ${pautaId} ganhou classe 'open' sozinho ap√≥s configura√ß√£o!`);
                console.error(`üö® MYSTERY BUG: Classes atuais:`, Array.from(dropdown.classList));
                dropdown.classList.remove('open', 'dropdown-up');
                console.error(`üö® MYSTERY BUG: Classe 'open' removida for√ßadamente`);
              }
            }, 50);
          });
          
          console.log(`üèÅ DROPDOWN: Configura√ß√£o de todos os ${statusDropdowns.length} dropdowns conclu√≠da`);
        }

        // Fun√ß√£o para atualizar contador
        function atualizarContador(pagination) {
          const contador = document.querySelector(".pautas-filters span");

          if (contador && pagination) {
            const inicio = (pagination.page - 1) * pagination.limit + 1;
            const fim = Math.min(inicio + pautas.length - 1, pagination.total);
            contador.textContent = `${inicio}-${fim} de ${pagination.total} pautas`;
          }
        }

        // Fun√ß√£o para configurar pagina√ß√£o
        function configurarPaginacao(pagination) {
          if (!pagination) return;

          const paginationContainer = document.getElementById(
            "pagination-container"
          );

          if (pagination.totalPages <= 1) {
            paginationContainer.style.display = "none";
            return;
          }

          paginationContainer.style.display = "flex";

          createPaginationControls({
            containerId: "pagination-controls",
            currentPage: pagination.page,
            totalItems: pagination.total,
            itemsPerPage: PAUTAS_PER_PAGE,
            onPageChange: (newPage) => {
              currentPage = newPage;
              const filtros = obterFiltrosAtuais();
              carregarPautas(currentPage, filtros);
            },
          });
        }

        // Fun√ß√£o para obter filtros atuais
        function obterFiltrosAtuais() {
          const statusFilter = document.getElementById("status-filter");
          const filtros = {};

          if (statusFilter && statusFilter.value !== "Todos os status") {
            filtros.status = statusFilter.value;
          }

          return filtros;
        }

        // Fun√ß√£o para atualizar status da pauta no banco
        async function atualizarStatusPauta(pautaId, novoStatus) {
          try {
            console.log(`üì° Atualizando status da pauta ${pautaId} para "${novoStatus}"...`);
            
            const token = localStorage.getItem("authToken");
            if (!token) {
              throw new Error("Token n√£o encontrado");
            }

            const response = await fetch(`/api/pautas/${pautaId}/status`, {
              method: "PUT",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                status: novoStatus
              })
            });

            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.error || `Erro ${response.status}`);
            }

            const result = await response.json();
            console.log(`‚úÖ Status atualizado com sucesso:`, result.data);
            
            // Status atualizado com sucesso
            
            return result.data;
            
          } catch (error) {
            console.error("‚ùå Erro ao atualizar status da pauta:", error);
            showToast(error.message, 'error');
            throw error;
          }
        }

        // Fun√ß√£o para mostrar mensagem de erro
        function mostrarMensagemErro(mensagem) {
          const tbody = document.querySelector(".pautas-table tbody");
          tbody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; padding: 2rem; color: var(--accent-red);">
                <i class="fa-solid fa-triangle-exclamation" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                ${mensagem}
              </td>
            </tr>
          `;
        }

        // Configurar filtro de status
        const statusFilter = document.getElementById("status-filter");
        if (statusFilter) {
          statusFilter.addEventListener("change", (e) => {
            currentPage = 1; // Resetar para primeira p√°gina ao filtrar
            const filtros = obterFiltrosAtuais();
            carregarPautas(currentPage, filtros);
          });
        }
      });
    </script>
  </body>
</html>
