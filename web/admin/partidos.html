<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerenciar Partidos - Legisla Net</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèõÔ∏è</text></svg>"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
    />
    <link rel="stylesheet" href="../css/global.css" />
    <link rel="stylesheet" href="../css/forms.css" />
    <link rel="stylesheet" href="../css/admin.css" />
    <link rel="stylesheet" href="../css/modals.css" />
    <link rel="stylesheet" href="../css/pagination.css" />
    <link rel="stylesheet" href="../css/carregamento.css" />
    <style>
      .content-area {
        margin-bottom: 32px;
      }

      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
      }
      .page-header h2 {
        margin: 0;
      }
      #partidos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 24px;
      }
      .party-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        transition: all 0.2s ease-in-out;
      }
      .party-card:hover {
        border-color: var(--accent-blue);
        transform: translateY(-4px);
      }
      .party-card-info {
        display: flex;
        align-items: center;
        gap: 12px;
        padding-bottom: 12px;
        margin-bottom: 12px;
        border-bottom: 1px solid var(--border-color);
      }
      .party-card-logo {
        width: 40px;
        height: 40px;
        object-fit: contain;
        background-color: #fff;
        border-radius: 6px;
        padding: 4px;
        flex-shrink: 0;
      }
      .party-card-details {
        display: flex;
        flex-direction: column;
      }
      .party-card-name {
        font-size: 1rem;
        margin: 0;
        font-weight: 600;
      }
      .party-card-sigla {
        color: var(--secondary-text);
        font-size: 0.85rem;
        margin: 0;
      }
      .party-card-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        padding-top: 12px;
        margin-top: auto;
      }
      .party-card-actions .btn {
        padding: 6px 12px;
        font-size: 0.85rem;
      }

      /* Ajuste do preview da logo */
      .logo-preview-wrapper {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 16px;
        background-color: var(--input-bg);
        padding: 8px;
        border-radius: 4px;
        border: 1px solid var(--border-color);
      }
      #edit-logo-preview {
        width: 50px;
        height: 50px;
        object-fit: contain;
        background-color: #fff;
        padding: 4px;
        border-radius: 6px;
      }

      /* Bot√£o remover */
      .btn.btn-danger {
        background-color: #da3633 !important;
        color: white !important;
      }

      /* Corrigir compatibilidade do modal (usando .visible em vez de .active) */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
      }
      .modal-overlay.visible {
        opacity: 1;
        visibility: visible;
      }
      .modal-overlay.visible .modal-content {
        transform: scale(1);
      }
      .modal-content {
        transform: scale(0.95);
        transition: transform 0.3s;
      }
    </style>
  </head>
  <body>
    <div class="app-layout">
      <div id="sidebar-placeholder"></div>
      <main class="main-content" id="mainContent">
        <div id="header-placeholder"></div>

        <section class="content-section fade-in">
          <div class="page-content-wrapper">
            <div class="content-area">
              <div class="page-header">
                <h2>Partidos Pol√≠ticos Cadastrados</h2>
                <a
                  href="/admin/novo_partido.html"
                  class="btn btn-primary"
                  style="text-decoration: none"
                  ><i class="fa-solid fa-plus"></i> Adicionar Partido</a
                >
              </div>
              <div id="partidos-grid"></div>
            </div>
            <div class="pagination-container">
              <div class="pagination-controls" id="pagination-controls"></div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Modal Editar -->
    <div class="modal-overlay" id="edit-modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Editar Partido</h3>
          <button class="modal-close" data-close-modal="edit-modal-overlay">
            &times;
          </button>
        </div>
        <form id="edit-party-form" class="form-container">
          <input type="hidden" id="edit-party-id" name="id" />
          <div class="form-group">
            <label for="edit-party-name">Nome do Partido</label>
            <input
              type="text"
              id="edit-party-name"
              name="nome"
              class="form-input"
              required
            />
          </div>
          <div class="form-group">
            <label for="edit-party-sigla">Sigla</label>
            <input
              type="text"
              id="edit-party-sigla"
              name="sigla"
              class="form-input"
              required
            />
          </div>
          <div class="form-group">
            <label for="edit-party-logo">Trocar Logo (opcional)</label>
            <div class="logo-preview-wrapper">
              <img id="edit-logo-preview" src="" alt="Logo atual" />
              <input
                type="file"
                id="edit-party-logo"
                name="logo"
                class="form-input"
                accept="image/*"
              />
            </div>
          </div>
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              data-close-modal="edit-modal-overlay"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
              Salvar Altera√ß√µes
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Deletar -->
    <div class="modal-overlay" id="delete-modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Confirmar Exclus√£o</h3>
          <button class="modal-close" data-close-modal="delete-modal-overlay">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <p>
            Voc√™ tem certeza que deseja remover o partido
            <strong id="delete-party-name"></strong>? Esta a√ß√£o n√£o pode ser
            desfeita.
          </p>
        </div>
        <div class="form-actions">
          <button
            type="button"
            class="btn btn-secondary"
            data-close-modal="delete-modal-overlay"
          >
            Cancelar
          </button>
          <button type="button" class="btn btn-danger" id="confirm-delete-btn">
            Sim, Remover
          </button>
        </div>
      </div>
    </div>

    <script src="../js/pagination.js"></script>
    <script src="../js/carregamento.js"></script>
    <script src="../js/global.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const authToken = localStorage.getItem("authToken");
        if (!authToken) {
          alert("Acesso negado. Por favor, fa√ßa o login como Super Admin.");
          window.location.href = "/app/login.html";
          return;
        }

        const PARTIDOS_PER_PAGE = 12;
        let currentPage = 1;

        const grid = document.getElementById("partidos-grid");
        const paginationControls = document.getElementById(
          "pagination-controls"
        );

        const editModal = {
          overlay: document.getElementById("edit-modal-overlay"),
          form: document.getElementById("edit-party-form"),
          id: document.getElementById("edit-party-id"),
          name: document.getElementById("edit-party-name"),
          sigla: document.getElementById("edit-party-sigla"),
          logoInput: document.getElementById("edit-party-logo"),
          logoPreview: document.getElementById("edit-logo-preview"),
        };

        const deleteModal = {
          overlay: document.getElementById("delete-modal-overlay"),
          partyName: document.getElementById("delete-party-name"),
          confirmBtn: document.getElementById("confirm-delete-btn"),
        };

        const fetchPartidos = async (page = 1) => {
          renderLoadingState(grid, "Carregando partidos...");

          try {
            const response = await fetch(
              `/api/partidos?page=${page}&limit=${PARTIDOS_PER_PAGE}`,
              {
                headers: { Authorization: `Bearer ${authToken}` },
              }
            );
            if (!response.ok) throw new Error("Falha ao buscar os partidos.");

            const { data, count } = await response.json(); // ‚Üê CORRE√á√ÉO 1
            renderPartidos(data);

            createPaginationControls({
              containerId: "pagination-controls",
              currentPage: page,
              totalItems: count, // ‚Üê CORRE√á√ÉO 2
              itemsPerPage: PARTIDOS_PER_PAGE,
              onPageChange: (newPage) => {
                currentPage = newPage;
                fetchPartidos(currentPage);
              },
            });
          } catch (error) {
            console.error("Erro ao carregar partidos:", error);
            renderErrorState(grid, error.message);
          }
        };

        const renderPartidos = (partidos) => {
          grid.style.display = "grid";
          if (!partidos || partidos.length === 0) {
            renderEmptyState(grid, "Nenhum partido cadastrado.", "fa-flag");
            return;
          }
          grid.innerHTML = "";
          partidos.forEach((partido) => {
            const card = document.createElement("div");
            card.className = "party-card";
            const defaultLogo = `https://ui-avatars.com/api/?name=${partido.sigla}&background=2A303C&color=fff&rounded=true&size=40`;
            card.innerHTML = `
                    <div class="party-card-info">
                        <img src="${
                          partido.logo_url || defaultLogo
                        }" alt="Logo de ${
              partido.nome
            }" class="party-card-logo">
                        <div class="party-card-details">
                            <h4 class="party-card-name">${partido.nome}</h4>
                            <p class="party-card-sigla">${partido.sigla}</p>
                        </div>
                    </div>
                    <div class="party-card-actions">
                        <button class="btn btn-secondary edit-btn" data-id="${
                          partido.id
                        }" data-nome="${partido.nome}" data-sigla="${
              partido.sigla
            }" data-logo="${partido.logo_url || ""}">Editar</button>
                        <button class="btn btn-danger delete-btn" data-id="${
                          partido.id
                        }" data-nome="${partido.sigla}">Remover</button>
                    </div>`;
            grid.appendChild(card);
          });
        };

        const openModal = (overlay) => overlay.classList.add("visible");
        const closeModal = (overlay) => overlay.classList.remove("visible");

        const openEditModal = (id, nome, sigla, logoUrl) => {
          editModal.id.value = id;
          editModal.name.value = nome;
          editModal.sigla.value = sigla;
          editModal.logoPreview.src =
            logoUrl ||
            `https://ui-avatars.com/api/?name=${sigla}&background=EAECEF&color=2A303C&rounded=true&size=50`;
          editModal.logoInput.value = ""; // Limpa o campo de arquivo
          openModal(editModal.overlay);
        };

        const openDeleteModal = (id, nome) => {
          deleteModal.partyName.textContent = nome;
          deleteModal.confirmBtn.dataset.id = id; // Armazena o ID no bot√£o
          openModal(deleteModal.overlay);
        };

        const handleUpdateSubmit = async (event) => {
          event.preventDefault();
          const id = editModal.id.value;
          const submitButton = editModal.form.querySelector(
            'button[type="submit"]'
          );
          submitButton.disabled = true;
          submitButton.innerHTML =
            '<i class="fa fa-spinner fa-spin"></i> Salvando...';

          const formData = new FormData(editModal.form);

          try {
            const response = await fetch(`/api/admin/partidos/${id}`, {
              method: "PUT",
              headers: { Authorization: `Bearer ${authToken}` }, // N√£o defina Content-Type
              body: formData,
            });

            if (!response.ok) {
              const err = await response.json();
              throw new Error(err.details || "Falha ao atualizar o partido.");
            }

            alert("Partido atualizado com sucesso!");
            closeModal(editModal.overlay);
            fetchPartidos(currentPage);
          } catch (error) {
            alert(`Erro: ${error.message}`);
          } finally {
            submitButton.disabled = false;
            submitButton.textContent = "Salvar Altera√ß√µes";
          }
        };

        const handleDeleteConfirm = async (event) => {
          const id = event.target.dataset.id;
          const submitButton = event.target;
          submitButton.disabled = true;
          submitButton.innerHTML =
            '<i class="fa fa-spinner fa-spin"></i> Removendo...';

          try {
            const response = await fetch(`/api/admin/partidos/${id}`, {
              method: "DELETE",
              headers: { Authorization: `Bearer ${authToken}` },
            });

            if (!response.ok) {
              const err = await response.json();
              throw new Error(err.details || "Falha ao remover o partido.");
            }

            alert("Partido removido com sucesso!");
            closeModal(deleteModal.overlay);
            fetchPartidos(currentPage);
          } catch (error) {
            alert(`Erro: ${error.message}`);
          } finally {
            submitButton.disabled = false;
            submitButton.textContent = "Sim, Remover";
          }
        };

        // --- Event Listeners ---
        grid.addEventListener("click", (event) => {
          const button = event.target.closest("button");
          if (!button) return;

          if (button.classList.contains("edit-btn")) {
            const { id, nome, sigla, logo } = button.dataset;
            openEditModal(id, nome, sigla, logo);
          }
          if (button.classList.contains("delete-btn")) {
            const { id, nome } = button.dataset;
            openDeleteModal(id, nome);
          }
        });

        editModal.form.addEventListener("submit", handleUpdateSubmit);
        deleteModal.confirmBtn.addEventListener("click", handleDeleteConfirm);

        editModal.logoInput.addEventListener("change", () => {
          const file = editModal.logoInput.files[0];
          if (file) {
            editModal.logoPreview.src = URL.createObjectURL(file);
          }
        });

        document.querySelectorAll("[data-close-modal]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const modalId = btn.dataset.closeModal;
            closeModal(document.getElementById(modalId));
          });
        });

        document.querySelectorAll(".modal-overlay").forEach((overlay) => {
          overlay.addEventListener("click", (event) => {
            if (event.target === overlay) {
              closeModal(overlay);
            }
          });
        });

        await initLayout({
          title: "Gerenciar Partidos",
          icon: "fa-flag",
          navActive: "nav-partidos",
        });
        fetchPartidos(currentPage);
      });
    </script>
  </body>
</html>
